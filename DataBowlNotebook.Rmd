---
title: 'Big Data Bowl'
output:
  html_document:
    theme: simplex
    highlight: pygments
    #css: "../css/note-style.css"
  pdf_document: default
---


First, we import all of the data.
```{r}
#getwd()

games <- read.csv("../../nfl-big-data-bowl-2024/games.csv")
players <- read.csv("../../nfl-big-data-bowl-2024/players.csv")
plays <- read.csv("../../nfl-big-data-bowl-2024/plays.csv")
tackles <- read.csv("../../nfl-big-data-bowl-2024/tackles.csv")
tracking_week_1 <- read.csv("../../nfl-big-data-bowl-2024/tracking_week_1.csv")
tracking_week_2 <- read.csv("../../nfl-big-data-bowl-2024/tracking_week_2.csv")
tracking_week_3 <- read.csv("../../nfl-big-data-bowl-2024/tracking_week_3.csv")
tracking_week_4 <- read.csv("../../nfl-big-data-bowl-2024/tracking_week_4.csv")
tracking_week_5 <- read.csv("../../nfl-big-data-bowl-2024/tracking_week_5.csv")
tracking_week_6 <- read.csv("../../nfl-big-data-bowl-2024/tracking_week_6.csv")
tracking_week_7 <- read.csv("../../nfl-big-data-bowl-2024/tracking_week_7.csv")
tracking_week_8 <- read.csv("../../nfl-big-data-bowl-2024/tracking_week_8.csv")
tracking_week_9 <- read.csv("../../nfl-big-data-bowl-2024/tracking_week_9.csv")
library(dplyr)

```
Now, I concatenate every week into one dataframe, join to the tackle dataframe, and clean out unnecessary columns.
```{r}

library(dplyr)

# Assuming 'gameId', 'playId', and 'nflId' are the columns you want to use for the surrogate key
surrogate_key_function <- function(df) {
  df %>%
    mutate(surrogate_key = paste0(gameId, playId, nflId))
}

# Create a list of data frames
totalList <- list(tracking_week_1, tracking_week_2, tracking_week_3, tracking_week_4, tracking_week_5, tracking_week_6, tracking_week_7, tracking_week_8, tracking_week_9)

# Apply the surrogate_key_function to each data frame in totalList
totalList <- lapply(totalList, surrogate_key_function)

# Load the tackles data
tackles <- tackles %>%
  mutate(surrogate_key = paste0(gameId, playId, nflId))

# Initialize an empty dataframe to store the concatenated results
combined_df <- data.frame()

columns_to_remove <- c("forcedFumble", "frameId", "time", "x", "y", "s", "a", "dis", "o", "playDirection", "dir", "jerseyNumber")

# Loop through each week, perform filtering, and concatenate the results
for (i in seq_along(totalList)) {
  week_t <- inner_join(tackles, totalList[[i]], by = "surrogate_key")
  week_t_filtered <- distinct(week_t)
  week_t_cleaned <- week_t_filtered %>% select(-columns_to_remove)
  combined_df <- bind_rows(combined_df, week_t_cleaned)
}

# Clear the surrogate key and duplicates now that they are no longer needed

col <- c("surrogate_key", "gameId.y", "playId.y", "nflId.y", "event")
combined_df <- combined_df %>% select(-col)
# Arrange the combined dataframe
baseframe <- combined_df %>% arrange(gameId.x, nflId.x, playId.x)
names(baseframe) <- c("gameID", "playID", "nflID", "tackle", "assist", "missedTackle", "playerName", "club")
baseframe <- distinct(baseframe)
# Print the ordered combined dataframe
head(baseframe, 55)


```
Now, I will calculate tackling percentage for each player. First, I'll count their number of attempted tackles (includes successful, assisted, and missed tackles) in the sample set.

```{r}


#names(name_counts) <- c("playerName", "tackleAttempts")
#print(name_counts)


attemptFrame <- baseframe %>%
  count(playerName)





tackleF <- baseframe %>%
  filter(tackle == 1) %>%
  count(playerName)

assistF <- baseframe %>%
  filter(assist == 1) %>%
  count(playerName)

missedF <- baseframe %>%
  filter(missedTackle == 1) %>%
  count(playerName)


resultF <- inner_join(tackleF, assistF, by = "playerName")
resultF <- inner_join(resultF, missedF, by = "playerName")

names(resultF) <- c("playerName", "tackles", "assists", "misses")

resultF <- resultF %>% mutate(attempted = tackles + assists + misses) ### BECAUSE SOME PLAYS A GUY DOES 2


resultF <- resultF %>% arrange(playerName)
head(resultF,25)
```



Now, I'll calculate their tackle percentage. Before doing this, I'll calculate their weighted tackle total, which counts assists as half a tackle.

```{r}
resultF <- resultF %>% mutate(weightedTack = tackles + .5*assists)

resultF <- resultF %>% mutate(tacklePerc = weightedTack / attempted)
head(resultF, 25)
```



